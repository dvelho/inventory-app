on:
  push:
    branches:
      - main
      - master
      - dev
      - stage
permissions:
  id-token: write
  contents: read #This is required for actions/checkout@v2
jobs:
  native_build:
    runs-on: ubuntu-latest

    name: Build native Quarkus app
    steps:
        # I only need to declare environment variables once at the beginning
        # The subsequent steps can access the variables by default
      - name: Configuration for master branch
        if: ${{ github.ref == 'refs/heads/master' }}
        # Side note, I can run any Linux command here, not just 'echo' original -> echo "GCP_WIP=${{ secrets.MAIN_WIP }}" >> $GITHUB_ENV
        run: |
          echo "AWS_DEFAULT_REGION=us-east-1" >> $GITHUB_ENV
      - name: Configuration for dev branch
        if: ${{ github.ref == 'refs/heads/dev' }}
        run: |
          echo "AWS_DEFAULT_REGION=eu-west-1" >> $GITHUB_ENV
      - name: Branch name
        run: echo running on branch ${GITHUB_REF##*/}
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: "GitHubActions"
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
      - name: Checkout the code
        uses: actions/checkout@master
      - name: Config graalvm
        uses: graalvm/setup-graalvm@v1
        with:
            version: 'latest'
            java-version: '19'
            components: 'native-image'
      - name: Maven Clean and install
        run: |
          mvn  clean verify -Dnative 

      #- name: Set up Homebrew
      #  id: set-up-homebrew
      #  uses: Homebrew/actions/setup-homebrew@master
      - name: Maven Clean and Verify on MainAuthorizerNative
        run: |
          mvn -f product/service/lambda-services/cognito/main-authorizer/pom.xml -q clean verify -Dnative -DskipTests
      #- name: Invoke local native app
      #  run: |
      #    sam local invoke --template target/sam.native.yaml --event payload.json
      - name: Maven Clean and Verify on OrdersApiNative
        run: |
          mvn -f product/service/api-services/orders-api/pom.xml -q clean verify -Dnative -DskipTests

      - name: Sam build
        run: |
          sam build --template infrastructure/service-lambda-cognito.yaml --base-dir product/service/lambda-services/cognito/main-authorizer
      - name: Sam deploy
        run: |
          sam deploy --template-file .aws-sam/build/template.yaml --resolve-s3 --stack-name testing-actions --capabilities CAPABILITY_IAM